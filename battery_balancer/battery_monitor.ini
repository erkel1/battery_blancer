; Battery Monitor Configuration File (battery_monitor.ini)
; Updated as of August 21, 2025.
; This INI file configures the combined battery temperature monitoring and balancing script for a 3s8p battery system (3 series-connected parallel battery banks, each with 8 cells).
; It merges settings from the original balancer and temperature scripts, with temperature-specific params in [Temp] and shared/general in [General].
; Sections:
; - [Temp]: Settings for temperature monitoring via Modbus over TCP (Lantronix EDS4100 device with NTC sensors).
; - [General]: Shared settings for balancing, polling, voltage thresholds, alarms, etc.
; - [I2C]: Addresses for I2C devices (multiplexer for channel select, ADC for voltage, relays for balancing).
; - [GPIO]: GPIO pins on Raspberry Pi for DC-DC converter control and alarm relay.
; - [Email]: Settings for SMTP email alerts on critical voltage/temp issues (throttled to prevent spam).f
; - [ADC]: Configuration registers and bitmasks for the ADS1115 ADC (advanced; rarely change).
; - [Calibration]: Per-sensor calibration multipliers for voltage readings (tune based on measured vs actual).
; - [Startup]: Settings for the startup self-test (balancer verification, etc.).
; - [Web]: Settings for the web interface (host, port, auth, etc.).

; Usage Notes:
; - All values have fallbacks in the script, so missing keys use defaults (listed below).
; - Types: string (text), integer (whole number), float (decimal, e.g., 0.1).
; - Thresholds: Tune to your battery type (e.g., LiFePO4: ~3.0-3.65V per cell, temps <60°C high, >0°C low).
; - For temps: 24 channels (8 per bank), scaling_factor assumes raw * scaling = °C (e.g., 100 for 0.01°C units).
; - For voltages: 3 banks, divider ratio = R2/(R1+R2) from circuit.
; - Email: Use app-specific password if 2FA enabled; test SMTP separately.
; - Logging: Set level in [General] (DEBUG for verbose, INFO default).
; - Changes require script restart; validate hardware matches (e.g., I2C addresses).
; - Script warns if NumberOfBatteries != 3 (hardcoded NUM_BANKS).
; - Web: Optional interface for remote monitoring/balancing; requires auth if enabled.

[Temp]
; IP address of the Lantronix EDS4100 device with NTC sensors
ip = 192.168.15.240
; Port for Modbus over TCP communication
port = 10001
; Interval between temperature polls in seconds (increased for slow Lantronix)
poll_interval = 15.0
; Temperature rise threshold for abnormal rise detection (°C)
rise_threshold = 2.0
; Relative deviation threshold from bank median (%)
deviation_threshold = 0.1
; Maximum allowed lag from bank group temperature changes (°C)
disconnection_lag_threshold = 0.5
; High temperature threshold for alerts (°C)
high_threshold = 60.0
; Low temperature threshold for alerts (°C)
low_threshold = 0.0
; Scaling factor to convert raw sensor values to °C
scaling_factor = 100.0
; Minimum valid temperature reading value
valid_min = 0.0
; Maximum number of retries for temperature reading (increased for reliability)
max_retries = 5
; Base for exponential backoff between retries (increased for slow device)
retry_backoff_base = 2
; Delay between query and response for Modbus communication (increased for slow Lantronix)
query_delay = 1.5
; Total number of temperature sensor channels
num_channels = 24
; Absolute deviation threshold from bank median (°C)
abs_deviation_threshold = 2.0

[General]
; Number of battery banks (must be 3 for 3s8p configuration)
NumberOfBatteries = 3
; Minimum voltage difference required to trigger balancing (V)
VoltageDifferenceToBalance = 0.1
; Duration of balancing operation in seconds
BalanceDurationSeconds = 5
; Sleep time between voltage checks in seconds
SleepTimeBetweenChecks = 0.1
; Minimum rest period between balancing operations in seconds
BalanceRestPeriodSeconds = 60
; Low voltage threshold per battery bank (V) - adjust for your battery chemistry
LowVoltageThresholdPerBattery = 18.5
; High voltage threshold per battery bank (V) - adjust for your battery chemistry
HighVoltageThresholdPerBattery = 21.0
; Minimum interval between email alerts in seconds
EmailAlertIntervalSeconds = 3600
; I2C bus number on Raspberry Pi (typically 1 for newer models)
I2C_BusNumber = 1
; Voltage divider ratio for ADC measurement circuit
VoltageDividerRatio = 0.01592
; Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LoggingLevel = INFO
; Enable or disable web interface
WebInterfaceEnabled = true
; Enable or disable startup self-test
StartupSelfTestEnabled = true

[I2C]
; I2C address of the multiplexer for channel selection
MultiplexerAddress = 0x70
; I2C address of the voltage meter ADC
VoltageMeterAddress = 0x49
; I2C address of the relay controller
RelayAddress = 0x26

[GPIO]
; GPIO pin number for DC-DC converter relay control
DC_DC_RelayPin = 17
; GPIO pin number for alarm relay control
AlarmRelayPin = 27

[Email]
; SMTP server for email alerts
SMTP_Server = smtp.gmail.com
; SMTP port (587 for TLS)
SMTP_Port = 587
; Sender email address
SenderEmail = your_email@gmail.com
; Recipient email address for alerts
RecipientEmail = recipient@example.com
; SMTP username (usually same as sender email)
SMTP_Username = your_email@gmail.com
; SMTP password or app-specific password
SMTP_Password = your_app_password

[ADC]
; Configuration register address for ADC
ConfigRegister = 0x01
; Conversion register address for ADC
ConversionRegister = 0x00
; Configuration value for continuous mode
ContinuousModeConfig = 0x0100
; Configuration value for sample rate
SampleRateConfig = 0x0080
; Configuration value for gain setting
GainConfig = 0x0400

[Calibration]
; Calibration multiplier for voltage sensor 1
Sensor1_Calibration = 0.99856
; Calibration multiplier for voltage sensor 2
Sensor2_Calibration = 0.99856
; Calibration multiplier for voltage sensor 3
Sensor3_Calibration = 0.99809

[Startup]
; Duration of balance test during startup in seconds
test_balance_duration = 15
; Minimum voltage delta required for test to pass (V)
min_voltage_delta = 0.01
; Interval between voltage reads during test in seconds
test_read_interval = 2

[Web]
; Web server host address (0.0.0.0 for all interfaces)
host = 0.0.0.0
; Web server port number
port = 8080
; Enable or disable authentication for web interface
auth_required = false
; Username for web authentication
username = admin
; Password for web authentication
password = admin123
; Enable or disable API endpoints
api_enabled = true
; Enable or disable CORS for web interface
cors_enabled = true
; Allowed CORS origins
cors_origins = *